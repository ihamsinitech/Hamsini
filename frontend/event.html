<!DOCTYPE html>
<html>
<head>
  <title>Events - Hamsini Tech Solutions</title>
  <link rel="icon" type="image/png" sizes="48x48" href="favicon.png">
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: "Segoe UI", sans-serif;
      background: url("https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1950&q=80")
                  no-repeat center center/cover;
      backdrop-filter: blur(6px);
    }

    header {
      background: rgba(0, 11, 36, 0.5);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }

    header a {
      color: #fff;
      text-decoration: none;
      margin-left: 20px;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    header a:hover {
      color: #00b7ff;
    }

    .events-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
    }

    .events-title {
      color: white;
      text-align: center;
      font-size: 32px;
      margin-bottom: 30px;
    }

    /* Folder Styles */
    .folder-container {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .folder-header {
      display: flex;
      align-items: center;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 10px;
      color: white;
    }

    .folder-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .folder-icon {
      font-size: 24px;
      margin-right: 15px;
      transition: transform 0.3s ease;
    }

    .folder-icon.expanded {
      transform: rotate(90deg);
    }

    .folder-info {
      flex-grow: 1;
    }

    .folder-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .folder-stats {
      font-size: 14px;
      opacity: 0.8;
    }

    .folder-content {
      display: none;
      margin-top: 15px;
    }

    .folder-content.expanded {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Image Grid Styles */
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .image-item {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
      aspect-ratio: 1;
    }

    .image-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }

    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .image-preview:hover {
      transform: scale(1.05);
    }

    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .image-item:hover .image-overlay {
      opacity: 1;
    }

    .image-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .delete-btn {
      background: rgba(255, 0, 0, 0.7);
    }

    .delete-btn:hover {
      background: rgba(255, 0, 0, 0.9);
    }

    .no-media {
      color: white;
      text-align: center;
      padding: 40px;
      grid-column: 1 / -1;
    }

    /* Video item styles */
    .video-item {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
      aspect-ratio: 1;
    }

    .video-preview {
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .video-icon {
      font-size: 40px;
      color: white;
    }

    /* Enhanced Preview Modal with Glassmorphism */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
    }

    .modal-content {
      position: relative;
      margin: 2% auto;
      padding: 0;
      width: 95%;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
      overflow: hidden;
      animation: modalSlideIn 0.4s ease;
    }

    /* Modal Header */
    .modal-header {
      background: rgba(0, 11, 36, 0.7);
      padding: 20px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .modal-title {
      color: white;
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }

    .modal-close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    /* Modal Body */
    .modal-body {
      padding: 30px;
      text-align: center;
    }

    .modal-media {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-info {
      margin-top: 20px;
      color: white;
    }

    .modal-description {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .modal-date {
      font-size: 14px;
      opacity: 0.7;
    }

    /* Modal Footer */
    .modal-footer {
      padding: 20px 30px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
    }

    .modal-btn {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .modal-btn.delete {
      background: rgba(255, 0, 0, 0.3);
    }

    .modal-btn.delete:hover {
      background: rgba(255, 0, 0, 0.5);
    }

    /* Delete Confirmation Modal */
    .confirm-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
    }

    .confirm-content {
      background: rgba(255, 255, 255, 0.15);
      margin: 20% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: white;
      text-align: center;
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .confirm-btn {
      background: rgba(255, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .confirm-btn:hover {
      background: rgba(255, 0, 0, 0.9);
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0; 
        transform: scale(0.8) translateY(-50px); 
      }
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
      }
    }

    /* Loading State */
    .loading {
      color: white;
      text-align: center;
      padding: 40px;
    }

    .error-message {
      color: #ff6b6b;
      text-align: center;
      padding: 20px;
      background: rgba(255,0,0,0.1);
      border-radius: 10px;
      margin: 10px 0;
    }

    .debug-info {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 12px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .modal-content {
        margin: 5% auto;
        width: 95%;
      }
      
      .modal-header {
        padding: 15px 20px;
      }
      
      .modal-title {
        font-size: 20px;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .modal-footer {
        padding: 15px 20px;
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-actions {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

  <header>
    <div><strong>Hamsini Tech Solutions</strong></div>
    <div>
      <a href="index.html">Home</a>
      <a href="blogs.html">Blogs</a>
      <a href="newBatches.html">New Batches</a>
      <a href="hire.html">Hire From Us</a>
    </div>
  </header>

  <div class="events-container">
    <h1 class="events-title">Our Events Gallery</h1>

    <div id="foldersContainer">
      <div class="loading">Loading media files...</div>
    </div>
  </div>

  <!-- Enhanced Preview Modal -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Image Preview</h2>
        <span class="modal-close" onclick="closePreviewModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="modalMediaContent"></div>
        <div class="modal-info">
          <div class="modal-description" id="modalDescription"></div>
          <div class="modal-date" id="modalDate"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-actions">
          <button class="modal-btn" onclick="downloadImage()">üì• Download</button>
          <button class="modal-btn delete" onclick="openDeleteFromModal()">üóëÔ∏è Delete</button>
        </div>
        <div style="color: rgba(255,255,255,0.7); font-size: 14px;">
          Press ESC to close
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="confirm-modal">
    <div class="confirm-content">
      <h3>Confirm Delete</h3>
      <p>Are you sure you want to delete this media item?</p>
      <p id="itemToDelete" style="font-weight: bold; margin: 10px 0;"></p>
      <div class="modal-buttons">
        <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
        <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentDeleteId = null;
    let currentDeleteFileName = null;
    let currentMediaItem = null;

    // Load and organize media files into folders
    async function loadMediaFiles() {
      try {
        console.log('Loading media files from API...');
        const response = await fetch('http://localhost:8081/api/admin/media');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const mediaItems = await response.json();
        console.log('Total media items loaded:', mediaItems.length);
        
        const foldersContainer = document.getElementById('foldersContainer');
        
        if (mediaItems.length === 0) {
          foldersContainer.innerHTML = '<div class="no-media">No media files available.</div>';
          return;
        }

        // Include both 'image' and 'auto' types since your backend is saving as 'auto'
        const itemsToShow = mediaItems.filter(item => 
          item.type === 'image' || item.type === 'auto'
        );

        console.log('Items to show after filtering:', itemsToShow.length);

        if (itemsToShow.length === 0) {
          foldersContainer.innerHTML = `
            <div class="no-media">
              No images available. 
              <div class="debug-info">
                Found ${mediaItems.length} total items but none are images.
                Item types: ${[...new Set(mediaItems.map(item => item.type))].join(', ')}
              </div>
            </div>`;
          return;
        }

        // Group media items by month-year for folder organization
        const folders = groupMediaByMonth(itemsToShow);
        console.log('Folders created:', Object.keys(folders));

        if (Object.keys(folders).length === 0) {
          foldersContainer.innerHTML = '<div class="no-media">No folders to display.</div>';
          return;
        }

        // Generate folder HTML
        foldersContainer.innerHTML = Object.keys(folders).map(monthYear => {
          const folderItems = folders[monthYear];
          const folderId = monthYear.replace(/\s+/g, '-').toLowerCase();
          
          return `
            <div class="folder-container">
              <div class="folder-header" onclick="toggleFolder('${folderId}')">
                <div class="folder-icon">üìÅ</div>
                <div class="folder-info">
                  <div class="folder-name">${monthYear}</div>
                  <div class="folder-stats">${folderItems.length} items</div>
                </div>
              </div>
              <div class="folder-content" id="${folderId}">
                <div class="images-grid">
                  ${folderItems.map(item => {
                    // Handle both image and auto types
                    const isImage = item.type === 'image' || item.type === 'auto';
                    
                    if (isImage) {
                      return `
                        <div class="image-item">
                          <img src="http://localhost:8081/uploads/${item.fileName}" 
                               class="image-preview" 
                               alt="${item.title}"
                               onclick="previewMedia(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                               onerror="this.onerror=null; this.src='https://via.placeholder.com/200x200/333/fff?text=Image+Error'; console.error('Failed to load: ${item.fileName}')">
                          <div class="image-overlay">
                            <div class="image-actions">
                              <button class="action-btn" onclick="previewMedia(${JSON.stringify(item).replace(/"/g, '&quot;')})">View</button>
                              <button class="action-btn delete-btn" onclick="openDeleteModal(${item.id}, '${item.title}', '${item.fileName}')">Delete</button>
                            </div>
                          </div>
                        </div>
                      `;
                    } else {
                      // For videos
                      return `
                        <div class="video-item">
                          <div class="video-preview" onclick="previewMedia(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                            <div class="video-icon">üé•</div>
                            <div style="position: absolute; bottom: 10px; left: 10px; right: 10px; color: white; font-size: 12px; text-align: center;">${item.title}</div>
                          </div>
                          <div class="image-overlay">
                            <div class="image-actions">
                              <button class="action-btn" onclick="previewMedia(${JSON.stringify(item).replace(/"/g, '&quot;')})">View</button>
                              <button class="action-btn delete-btn" onclick="openDeleteModal(${item.id}, '${item.title}', '${item.fileName}')">Delete</button>
                            </div>
                          </div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Auto-expand the first folder
        const firstFolderId = Object.keys(folders)[0].replace(/\s+/g, '-').toLowerCase();
        setTimeout(() => toggleFolder(firstFolderId), 100);
        
      } catch (error) {
        console.error('Error loading media:', error);
        document.getElementById('foldersContainer').innerHTML = 
          '<div class="error-message">Error loading media files. Please check if the server is running on localhost:8081.</div>';
      }
    }

    // Group media items by month and year
    function groupMediaByMonth(mediaItems) {
      const folders = {};
      
      mediaItems.forEach(item => {
        const date = new Date(item.uploadDate);
        const monthYear = date.toLocaleString('default', { 
          month: 'long', 
          year: 'numeric' 
        });
        
        if (!folders[monthYear]) {
          folders[monthYear] = [];
        }
        
        folders[monthYear].push(item);
      });
      
      // Sort folders by date (newest first)
      const sortedFolders = {};
      Object.keys(folders)
        .sort((a, b) => new Date(b) - new Date(a))
        .forEach(key => {
          sortedFolders[key] = folders[key];
        });
      
      return sortedFolders;
    }

    // Toggle folder expand/collapse
    function toggleFolder(folderId) {
      const folderContent = document.getElementById(folderId);
      const folderIcon = folderContent.previousElementSibling.querySelector('.folder-icon');
      
      folderContent.classList.toggle('expanded');
      folderIcon.classList.toggle('expanded');
    }

    // Enhanced Preview media function
    function previewMedia(item) {
      currentMediaItem = item;
      const modal = document.getElementById('previewModal');
      const modalContent = document.getElementById('modalMediaContent');
      const modalTitle = document.getElementById('modalTitle');
      const modalDescription = document.getElementById('modalDescription');
      const modalDate = document.getElementById('modalDate');
      
      console.log('Previewing media item:', item);
      
      // Set modal content based on media type
      if (item.type === 'image' || item.type === 'auto') {
        modalContent.innerHTML = `
          <img src="http://localhost:8081/uploads/${item.fileName}" 
               class="modal-media" 
               alt="${item.title}"
               onerror="alert('Failed to load image. Please check the console for details.'); console.error('Image load failed: ${item.fileName}')">`;
      } else if (item.type === 'video') {
        modalContent.innerHTML = `
          <video controls class="modal-media">
            <source src="http://localhost:8081/uploads/${item.fileName}" type="video/mp4">
            Your browser does not support the video tag.
          </video>`;
      } else {
        modalContent.innerHTML = `<p>Unsupported file type: ${item.type}</p>`;
      }
      
      // Set modal information
      modalTitle.textContent = item.title;
      modalDescription.textContent = item.description || 'No description available';
      modalDate.textContent = `Uploaded on: ${new Date(item.uploadDate).toLocaleDateString()}`;
      
      modal.style.display = 'block';
    }

    // Download image function
    function downloadImage() {
      if (currentMediaItem) {
        const link = document.createElement('a');
        link.href = `http://localhost:8081/uploads/${currentMediaItem.fileName}`;
        link.download = currentMediaItem.originalFileName || currentMediaItem.fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    // Open delete from modal
    function openDeleteFromModal() {
      if (currentMediaItem) {
        openDeleteModal(currentMediaItem.id, currentMediaItem.title, currentMediaItem.fileName);
        closePreviewModal();
      }
    }

    // Close preview modal
    function closePreviewModal() {
      document.getElementById('previewModal').style.display = 'none';
      currentMediaItem = null;
    }

    // Open delete confirmation modal
    function openDeleteModal(itemId, itemTitle, fileName) {
      currentDeleteId = itemId;
      currentDeleteFileName = fileName;
      document.getElementById('itemToDelete').textContent = `"${itemTitle}"`;
      document.getElementById('deleteModal').style.display = 'block';
    }

    // Close delete modal
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentDeleteId = null;
      currentDeleteFileName = null;
    }

    // Confirm and delete item
    async function confirmDelete() {
      if (currentDeleteId) {
        try {
          const response = await fetch(`http://localhost:8081/api/admin/media/delete/${currentDeleteId}`, {
            method: 'POST'
          });
          
          if (response.ok) {
            alert('Media item deleted successfully!');
            closeDeleteModal();
            loadMediaFiles(); // Reload the media list
          } else {
            const errorText = await response.text();
            alert('Failed to delete media item: ' + errorText);
          }
        } catch (error) {
          console.error('Error deleting media:', error);
          alert('Error deleting media item. Please try again.');
        }
      }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const previewModal = document.getElementById('previewModal');
      const deleteModal = document.getElementById('deleteModal');
      
      if (event.target === previewModal) {
        closePreviewModal();
      }
      if (event.target === deleteModal) {
        closeDeleteModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closePreviewModal();
        closeDeleteModal();
      }
    });

    // Load files when page loads
    document.addEventListener('DOMContentLoaded', loadMediaFiles);
  </script>
</body>
</html>